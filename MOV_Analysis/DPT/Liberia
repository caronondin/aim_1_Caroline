# MOV data analysis for Liberia for dpt
# Author: Caroline Nondin
# Objective: Understand if high performing countries such as Liberia 
#successfully addressed “missed opportunities” for dpt, and which factor are 
#significantly associated with MOV 
# date: Last modified 12/04/22

#Libraries:
library(aod)
library(dplyr)
library(ggplot2)
library(tibble)

#libraries for visualizations 
library(broom)
library(tidyverse)
library(pixiedust)
library(kableExtra)

#setting up team one drive and code repo 
g_drive  <- '/Users/cnondin/Library/CloudStorage/OneDrive-SharedLibraries-UW/og_phi_global_vaccination_improvement_project - General/'
code_dir <- 'C:/Documents/PHI TA job/aim 1/git_repo/uw-phi-vax/global_vac_index/'
prepped_data_dir <- paste0(g_drive,"Data/prepped_data/") # location of prepped data

#Opening relevant data files (04_prepped_dhs_for_MOV):
prep_data_Lib <- paste0(prepped_data_dir, "aim_1/04_prepped_dhs_for_mov_Lib.RDS")

#Loading data 
dt_Lib <- as_tibble(readRDS(prep_data_Lib))

#selecting the variables relevant to MOV analysis: 
#these include: dpt_missed_opportunity (outcome), wom_agecat, edu, female_head, literate, total_children_born, wom_occ, marital, hhsize, assets, urban, strata
dt_Lib <- select(dt_Lib, dpt_missed_opportunity, wom_agecat, edu, female_head,
                 literate, total_children_born, wom_occ, marital, hhsize, assets, urban, strata)

################## ######## Analysis Liberia ##################################

#logistic regression Liberia:  
mylogit_Lib <- glm(dpt_missed_opportunity ~ wom_agecat + edu + female_head + literate +
                     total_children_born + wom_occ + marital + hhsize + assets + 
                     urban + strata, data = dt_Lib, family = "binomial")
summary(mylogit_Lib)

#making a table with the results of the regression: 
dust(mylogit_Lib) %>%
  sprinkle(col = 2:4, round = 3) %>%
  sprinkle(col = 5, fn = quote(pvalString(value))) %>%
  kable() %>%
  kable_styling()

#calculating CIs using the standard error (can also do using log-likelihood if better):
confint.default(mylogit_Lib)

#wald test: 
#for age of mother:
Chi2_age = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 2:3)
#for education level: 
Chi2_edu = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 4:5)
#for sex of head of house: 
Chi2_house = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 6)
#Literacy levels: 
Chi2_lit = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 7)
#Total nb of children born: 
Chi2_children = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 8:10)
#respondents occupation: 
Chi2_occ = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 11)
#maritial status: 
Chi2_mar = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 12:14)
#household size: 
Chi2_housesize = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 15)
#Wealth index: 
Chi2_wealth = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 16:19)
#urban vs. rural: 
Chi2_urbvrur = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 20)
#year: 
Chi2_year = wald.test(b = coef(mylogit_Lib), Sigma = vcov(mylogit_Lib), Terms = 21)

#calculating the odds ratios and the 95% CI: 
OR_CI_data_Lib = exp(cbind(OR = coef(mylogit_Lib), confint(mylogit_Lib)))
OR_CI_data_Lib = as.data.frame(OR_CI_data_Lib)
OR_Lib = OR_CI_data_Lib$OR
CI_Lib_2.5 = OR_CI_data_Lib$`2.5 %`
CI_Lib_97.5 = OR_CI_data_Lib$`97.5 %`

#making a forest plot with the ORs: 
dat_FP_Lib <- data.frame(
  Index = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21), ## This provides an order to the data
  label = c("Intercept", "Current age in yrs (15-19 vs. 20-34)", "Current age in yrs (15-19 vs. 35-49)", "Education (None vs. Primary)", "Education (None vs. Secondary or higher)",
            "Sex head houshold (male vs. female)", "Literacy (Iliterate vs. Literate)", "nb children (1 vs. 2-3)", "nb children (1 vs. 4-5)", "nb children (1 vs. 6+)", 
            "Unemployed vs. Employed", "Marital Status (Single vs. Married)", "Marital Status (Single vs. Union)", "Marital Status (Single vs. Divorced, seperated, widowed, or other)", 
            "Household Size", "Household Assets (quintile 1 vs. 2)", "Household Assets (quintile 1 vs. 3)", "Household Assets (quintile 1 vs. 4)", 
            "Household Assets (quintile 1 vs. 5)", "Rural vs. Urban Residence", "DHS Year (2013 vs. 2019)"),
  OR = OR_Lib,
  CI_Lower = CI_Lib_2.5,
  CI_Upper = CI_Lib_97.5
)
dat_FP_Lib

FP_Lib <- ggplot(dat_FP_Lib, aes(y = Index, x = OR)) +
  geom_point(shape = 18, size = 5) +  
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.25) +
  geom_vline(xintercept = 1, color = "purple", linetype = "dashed", cex = 1, alpha = 0.5) +
  scale_y_continuous(name = "", breaks=1:21, labels = dat_FP_Lib$label, trans = "reverse") +
  xlab("Odds Ratio (97.5% CI)") + 
  ylab(" ") + 
  theme_bw() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.text.x.bottom = element_text(size = 12, colour = "black"),
        axis.title.x = element_text(size = 12, colour = "black"))
FP_Lib
#STEP 2: Making predictions based on year: 
#we're keeping all the other variables except for strata constant. 

#finding the most frequent value for certain variables: 
tail(names(sort(table(dt_Lib$wom_agecat))), 1) #age category 
tail(names(sort(table(dt_Lib$edu))), 1) #level of education 
tail(names(sort(table(dt_Lib$literate))), 1) #literacy level 
tail(names(sort(table(dt_Lib$total_children_born))), 1) #nb children in household   
tail(names(sort(table(dt_Lib$wom_occ))), 1) #occupation 
tail(names(sort(table(dt_Lib$assets))), 1) #asset quintile 
tail(names(sort(table(dt_Lib$urban))), 1) #urban vs. rural 

#making a dataset with the baseline values for the variables: 
pred_prob_data_Lib <- with(dt_Lib, data.frame(wom_agecat = "20-34", edu = "No education",  female_head = "Female", literate = "Iliterate",
                                              total_children_born = "2-3 children", wom_occ = "Employed", marital = "Married", hhsize = mean(hhsize), 
                                              assets = "Quintile 1", urban = "Rural household", strata = c("2013", "2019")))
pred_prob_data_Lib
pred_prob_data_Lib$strataP <- predict(mylogit_Lib, newdata = pred_prob_data_Lib, type = "response")
pred_prob_data_Lib

